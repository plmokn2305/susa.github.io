<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>議會監督網站</title>
  <meta name="description" content="以 GitHub Pages 架設的議會監督網站：議員對照表、出席率、質詢率、連署與提案統計。" />
  <style>
    :root{
      --bg:#0b0f14; --panel:#121923; --muted:#9fb0c2; --text:#e6eef7; --brand:#4fa3ff; --ok:#3ccf91; --warn:#ffb020; --bad:#ff6b6b; --chip:#1c2633;
      --card:#0f1520; --hover:#172031; --border:#1f2a3a; --shadow:0 10px 30px rgba(2,12,27,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 10% -10%,#17304d10,transparent),
                     radial-gradient(900px 600px at 110% 10%,#1e3a5f10,transparent),var(--bg);
         color:var(--text);font:16px/1.6 system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", sans-serif}
    a{color:inherit}
    .container{max-width:1200px;margin:0 auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#4fa3ff,#7bd7ff);display:grid;place-items:center;color:#001428;font-weight:900;box-shadow:var(--shadow)}
    .title h1{margin:0;font-size:20px}
    .title p{margin:0;color:var(--muted);font-size:12px}

    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .input, select{background:var(--panel);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:10px;outline:none;box-shadow:none;}
    .input:focus, select:focus{border-color:var(--brand)}
    .chip{background:var(--chip);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px;border:1px solid var(--border)}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px;margin-top:18px}
    .card{grid-column:span 6;background:linear-gradient(180deg,rgba(79,163,255,.06),transparent 40%),var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;position:relative;transition:.2s;box-shadow:0 0 0 rgba(0,0,0,0)}
    @media (min-width:900px){.card{grid-column:span 4}}
    .card:hover{transform:translateY(-2px);background:linear-gradient(180deg,rgba(79,163,255,.09),transparent 50%),var(--card);box-shadow:var(--shadow)}

    .card-head{display:flex;gap:12px}
    .avatar{width:64px;height:64px;border-radius:14px;flex:0 0 auto;object-fit:cover;border:1px solid var(--border);background:#0a0f16}
    .name{font-weight:700}
    .meta{color:var(--muted);font-size:13px}

    .metrics{display:grid;grid-template-columns:repeat(12,1fr);gap:10px;margin-top:10px}
    .metric{grid-column:span 6;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:8px}
    @media (min-width:900px){.metric{grid-column:span 3}}
    .metric h4{margin:0 0 6px 0;font-size:12px;color:var(--muted);font-weight:600}
    .metric .val{font-size:18px;font-weight:800}
    .bar{height:8px;background:#0e1420;border-radius:999px;border:1px solid var(--border);overflow:hidden;margin-top:6px}
    .bar>i{display:block;height:100%;background:linear-gradient(90deg,var(--ok),var(--brand));width:0}

    .spark{margin-top:10px;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:8px}
    .spark h5{margin:0 0 4px 0;font-size:12px;color:var(--muted);font-weight:600}
    .spark svg{display:block;width:100%;height:36px}
    .spark .legend{display:flex;justify-content:space-between;font-size:11px;color:var(--muted)}

    .card .more{position:absolute;right:10px;top:10px;background:transparent;border:1px solid var(--border);color:var(--muted);border-radius:8px;padding:6px 8px;cursor:pointer}
    .card .more:hover{background:var(--hover);color:var(--text)}

    .table-wrap{margin-top:28px;background:var(--panel);border:1px solid var(--border);border-radius:16px;overflow:auto}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
    th{position:sticky;top:0;background:linear-gradient(180deg,rgba(79,163,255,.06),transparent 30%),var(--panel);}

    /* Drawer */
    .drawer{position:fixed;inset:0;display:none}
    .drawer.show{display:block}
    .backdrop{position:absolute;inset:0;background:rgba(2,12,27,.55)}
    .panel{position:absolute;inset:0 0 0 auto;width:min(760px,100%);background:var(--panel);border-left:1px solid var(--border);box-shadow:var(--shadow);overflow:auto}
    .panel header{position:sticky;top:0;background:linear-gradient(180deg,rgba(79,163,255,.08),transparent 60%),var(--panel);border-bottom:1px solid var(--border);padding:14px}
    .panel .body{padding:16px}

    .kpis{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .kpi{grid-column:span 6;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
    @media (min-width:900px){.kpi{grid-column:span 3}}
    .kpi h3{margin:0;color:var(--muted);font-size:12px}
    .kpi .big{font-size:28px;font-weight:800;margin-top:4px}

    .chart{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;margin-top:14px}
    canvas{width:100%;height:200px}

    .list{margin-top:10px}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--border);font-size:11px;color:var(--muted)}

    footer{margin:40px 0 20px;color:var(--muted);font-size:12px;text-align:center}
    code.inline{background:#0e1420;border:1px solid var(--border);padding:2px 6px;border-radius:6px;color:#9bd}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">議</div>
        <div class="title">
          <h1>議會監督網站</h1>
          <p>議員對照表 · 出席率 · 質詢率 · 連署 · 提案數</p>
        </div>
      </div>
      <div class="toolbar">
        <input id="q" class="input" placeholder="搜尋議員姓名 / 選區..." />
        <select id="party"></select>
        <select id="district"></select>
        <span id="count" class="chip">0 位議員</span>
        <span id="live" class="chip">離線資料</span>
      </div>
    </header>

    <section id="cards" class="grid" aria-live="polite"></section>

    <div class="table-wrap" id="tableWrap" hidden>
      <table id="table">
        <thead>
          <tr>
            <th>議員</th>
            <th>政黨</th>
            <th>選區</th>
            <th>出席率</th>
            <th>質詢率</th>
            <th>連署數</th>
            <th>提案數</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <footer>
      支援以 <code class="inline">?proposals=CSV網址</code> 載入提案清單（或在 repo 放 <code class="inline">data/proposals.csv</code>）。
    </footer>
  </div>

  <!-- 詳細抽屜 -->
  <div id="drawer" class="drawer" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="backdrop" onclick="closeDrawer()"></div>
    <div class="panel">
      <header>
        <div class="brand">
          <img id="dPhoto" class="avatar" alt="議員照片" />
          <div class="title">
            <h1 id="dName" style="margin:0;font-size:18px"></h1>
            <p id="dMeta" class="meta"></p>
          </div>
        </div>
        <button class="more" onclick="closeDrawer()">關閉</button>
      </header>
      <div class="body">
        <div class="kpis">
          <div class="kpi"><h3>出席率</h3><div id="dAttend" class="big">—</div></div>
          <div class="kpi"><h3>質詢率</h3><div id="dInterp" class="big">—</div></div>
          <div class="kpi"><h3>連署數</h3><div id="dCo" class="big">—</div></div>
          <div class="kpi"><h3>提案數</h3><div id="dProp" class="big">—</div></div>
        </div>
        <div class="chart">
          <h3 style="margin:0 0 6px 0;color:var(--muted);font-size:12px">近期提案</h3>
          <div id="trendLegend" class="legend" style="display:flex;justify-content:space-between;color:var(--muted);font-size:12px"></div>
        </div>
        <div class="list" id="dList"></div>
      </div>
    </div>
  </div>

<script>
  // ============= 資料載入 =============
  const state = { all: [], filtered: [], parties: [], districts: [], current: null, proposalsByName:new Map(), live:false };

  async function initData(){
    try{
      const res = await fetch('data/councilors.json',{cache:'no-store'});
      if(res.ok){
        const json = await res.json();
        if(Array.isArray(json) && json.length){
          return json;
        }
      }
    }catch(err){}
    return SAMPLE_COUNCILORS;
  }

  async function initProposals(){
    // 1) 參數 ?proposals=CSV
    const pUrl = getParam('proposals');
    if(pUrl){
      const txt = await fetchText(pUrl);
      if(txt){ state.proposalsByName = parseProposalsCsv(txt); setLiveBadge(true); return; }
    }
    // 2) repo 本地 CSV
    try{ const res = await fetch('data/proposals.csv',{cache:'no-store'}); if(res.ok){ const txt = await res.text(); state.proposalsByName = parseProposalsCsv(txt); setLiveBadge(false); return; } }catch(e){}
    // 3) 從 councilors.json 內建陣列
    const m = new Map();
    for(const x of state.all){ if(Array.isArray(x.proposals)) m.set(x.name, x.proposals); }
    state.proposalsByName = m;
    setLiveBadge(false);
  }

  function setLiveBadge(on){
    const b = el('#live');
    if(!b) return; b.textContent = on? '即時資料（提案）' : '離線資料';
  }

  // ======= CSV 解析 =======
  function parseProposalsCsv(csv){
    const lines = csv.split(/
?
/).filter(l=>l.trim().length);
    if(!lines.length) return new Map();
    const headers = splitCsvLine(lines[0]).map(h=>h.trim());
    const idx = (names)=>{ for(const n of names){ const i = headers.findIndex(h=>h===n); if(i>-1) return i; } return -1; };
    const iMember = idx(['議員','姓名']);
    const iTitle = idx(['標題','提案標題']);
    const iDate = idx(['日期','提出日期','登錄日期']);
    const iType = idx(['類型','類別','類別/狀態']);
    const iCo = idx(['連署','連署名單','連署議員']);
    const map = new Map();
    for(let r=1;r<lines.length;r++){
      const cells = splitCsvLine(lines[r]);
      const name = (cells[iMember]||'').trim(); if(!name) continue;
      const title = (cells[iTitle]||'').trim();
      const date = (cells[iDate]||'').trim();
      const type = (cells[iType]||'').trim();
      const cos = (cells[iCo]||'').split(/[、,;，；]/).map(s=>s.trim()).filter(Boolean);
      const item = {title: title||'(無標題)', date, type: type||'提案', cosponsors: cos};
      if(!map.has(name)) map.set(name, []);
      map.get(name).push(item);
    }
    // 依日期倒序
    for(const [k,arr] of map){ arr.sort((a,b)=> (b.date||'').localeCompare(a.date||'')); }
    return map;
  }

  function splitCsvLine(line){
    const out=[]; let cur=''; let q=false; for(let i=0;i<line.length;i++){ const ch=line[i]; if(ch==='"'){ if(q && line[i+1]==='"'){ cur+='"'; i++; } else { q=!q; } } else if(ch===',' && !q){ out.push(cur); cur=''; } else { cur+=ch; } } out.push(cur); return out;
  }

  async function fetchText(url){ try{ const res = await fetch(url+((url.includes('?')?'&':'?')+'t='+Date.now())); if(res.ok) return await res.text(); }catch(e){} return ''; }

  // ======= UI 工具 =======
  const el = sel=>document.querySelector(sel);
  const fmtPct = n => (n==null? '—' : Math.round(n*100)+'%');
  const fmtNum = n => n==null? '—' : n.toLocaleString('zh-TW');
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const getParam = key => new URL(window.location.href).searchParams.get(key);

  function sparkline(values){
    if(!values || !values.length) return '<svg></svg>';
    const w = 220, h = 36, p=4;
    const max = Math.max(...values), min = Math.min(...values);
    const span = Math.max(1, values.length-1);
    const pts = values.map((v,i)=>{
      const x = p + (w-2*p) * (i/span);
      const y = h - p - ( (v-min) / (max-min || 1) ) * (h-2*p);
      return `${x.toFixed(1)},${y.toFixed(1)}`;
    }).join(' ');
    const last = values.at(-1), first = values[0];
    const trend = last>first? '上升' : last<first? '下降' : '持平';
    return `<svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none" aria-label="提案趨勢 ${trend}">
      <polyline points="${pts}" fill="none" stroke="url(#g)" stroke-width="2"/>
      <defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="${getComputedStyle(document.documentElement).getPropertyValue('--brand').trim()}"/><stop offset="1" stop-color="${getComputedStyle(document.documentElement).getPropertyValue('--ok').trim()}"/></linearGradient></defs>
    </svg>`
  }

  function metricBar(val){
    const pct = Math.round((val||0)*100);
    return `<div class="bar"><i style="width:${clamp(pct,0,100)}%"></i></div>`
  }

  // ======= 卡片＆表格 =======
  function renderFilters(){
    const parties = [...new Set(state.all.map(x=>x.party).filter(Boolean))].sort();
    const dists = [...new Set(state.all.map(x=>x.district).filter(Boolean))].sort();
    state.parties = parties; state.districts = dists;
    const partySel = el('#party');
    const distSel = el('#district');
    partySel.innerHTML = `<option value="">全部政黨</option>` + parties.map(p=>`<option>${p}</option>`).join('');
    distSel.innerHTML = `<option value="">全部選區</option>` + dists.map(d=>`<option>${d}</option>`).join('');
  }

  function applyFilter(){
    const q = el('#q').value.trim();
    const p = el('#party').value; const d = el('#district').value;
    state.filtered = state.all.filter(x=>{
      const textHit = !q || (x.name+" "+(x.district||'')+" "+(x.party||'')).includes(q);
      const pHit = !p || x.party===p; const dHit = !d || x.district===d;
      return textHit && pHit && dHit;
    });
    el('#count').textContent = `${state.filtered.length} 位議員`;
    renderCards();
    renderTable();
  }

  function renderCards(){
    const wrap = el('#cards');
    wrap.innerHTML = state.filtered.map(x=>{
      const m = x.stats || {};
      const monthly = (x.proposals_monthly||[]).map(it=>it.count);
      return `<article class="card" role="button" tabindex="0" onclick="openDrawer('${x.id}')" onkeypress="if(event.key==='Enter'){openDrawer('${x.id}')}" aria-label="查看 ${x.name} 詳細">
        <button class="more">詳情</button>
        <div class="card-head">
          <img class="avatar" alt="${x.name} 照片" src="${safePhoto(x.photo,x.name)}" onerror="this.src='https://picsum.photos/seed/${encodeURIComponent(x.name)}/128/128'"/>
          <div>
            <div class="name">${x.name}</div>
            <div class="meta">${x.party||'無黨籍'} · ${x.district||''}</div>
          </div>
        </div>
        <div class="metrics">
          <div class="metric"><h4>出席率</h4><div class="val">${fmtPct(m.attendance_rate)}</div>${metricBar(m.attendance_rate)}</div>
          <div class="metric"><h4>質詢率</h4><div class="val">${fmtPct(m.interpellation_rate)}</div>${metricBar(m.interpellation_rate)}</div>
          <div class="metric"><h4>連署數</h4><div class="val">${fmtNum(m.cosponsors_count)}</div></div>
          <div class="metric"><h4>提案數</h4><div class="val">${fmtNum(m.proposals_count)}</div></div>
        </div>
        <div class="spark">
          <h5>提案小走勢圖</h5>
          ${sparkline(monthly)}
          <div class="legend"><span>${(x.proposals_monthly?.[0]?.month)||''}</span><span>${(x.proposals_monthly?.at(-1)?.month)||''}</span></div>
        </div>
      </article>`
    }).join('');
  }

  function renderTable(){
    const tb = document.querySelector('#table tbody');
    tb.innerHTML = state.filtered.map(x=>{
      const m = x.stats||{};
      return `<tr onclick="openDrawer('${x.id}')" style="cursor:pointer">
        <td>${x.name}</td><td>${x.party||''}</td><td>${x.district||''}</td>
        <td>${fmtPct(m.attendance_rate)}</td><td>${fmtPct(m.interpellation_rate)}</td><td>${fmtNum(m.cosponsors_count)}</td><td>${fmtNum(m.proposals_count)}</td>
      </tr>`
    }).join('');
  }

  function safePhoto(url,name){
    return url && url.trim() ? url : `https://picsum.photos/seed/${encodeURIComponent(name)}/128/128`;
  }

  // ======= 詳細抽屜 =======
  function openDrawer(id){
    const x = state.all.find(v=>v.id===id);
    if(!x) return;
    state.current = x;
    el('#dPhoto').src = safePhoto(x.photo,x.name);
    el('#dName').textContent = x.name;
    el('#dMeta').textContent = `${x.party||'無黨籍'} · ${x.district||''}`;
    el('#dAttend').textContent = fmtPct(x.stats?.attendance_rate);
    el('#dInterp').textContent = fmtPct(x.stats?.interpellation_rate);
    el('#dCo').textContent = fmtNum(x.stats?.cosponsors_count);
    el('#dProp').textContent = fmtNum(x.stats?.proposals_count);

    // 取提案清單（CSV 或 JSON 內建）
    const list = state.proposalsByName.get(x.name) || x.proposals || [];
    el('#dList').innerHTML = (list.length? list.slice(0,20).map(it=>
      `<div style="display:flex;gap:10px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;margin:6px 0">
        <span class="pill">${it.type||'提案'}</span>
        <div style="flex:1">
          <div style="font-weight:700">${it.title||'(無標題)'}</div>
          <div class="meta">${it.date||''}${(it.cosponsors&&it.cosponsors.length)? ' · 連署：'+it.cosponsors.join('、'):''}</div>
        </div>
      </div>`
    ).join('') : `<div class="meta">暫無提案資料。可在網址加 <code class="inline">?proposals=CSV網址</code> 或放 <code class="inline">data/proposals.csv</code>。</div>`);

    const dr = el('#drawer');
    dr.classList.add('show');
    dr.setAttribute('aria-hidden','false');
  }
  function closeDrawer(){
    const dr = el('#drawer');
    dr.classList.remove('show');
    dr.setAttribute('aria-hidden','true');
  }

  function drawTrend(monthly){
    // 已移除趨勢圖繪製（保留容器顯示近期提案標題）
    el('#trendLegend').textContent = '';
  }

  function getCss(varName){
    return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
  }

  // ======= SAMPLE 假資料（可刪除） =======
  const SAMPLE_COUNCILORS = [
    {
      id:'c001', name:'林雅雯', party:'進步黨', district:'第一選區',
      photo:'',
      stats:{attendance_rate:.96, interpellation_rate:.52, cosponsors_count:48, proposals_count:22},
      proposals:[{title:'推動學校營養午餐在地採購計畫', date:'2025-07-12', type:'提案'}, {title:'改善捷運站無障礙指引標示', date:'2025-06-28', type:'連署', cosponsors:['王博仁','陳佩珊']}, {title:'社福補助資格放寬審查', date:'2025-05-11', type:'提案'}]
    },
    {
      id:'c002', name:'王博仁', party:'公民聯盟', district:'第二選區',
      photo:'',
      stats:{attendance_rate:.82, interpellation_rate:.31, cosponsors_count:35, proposals_count:12},
      proposals:[{title:'公園照明改善與增設監視器', date:'2025-07-02', type:'連署', cosponsors:['林雅雯']},{title:'打造青年創業共享空間', date:'2025-06-09', type:'提案'}]
    }
  ];

  // ======= 啟動 =======
  async function main(){
    state.all = await initData();
    await initProposals();
    renderFilters();
    el('#q').addEventListener('input', applyFilter);
    el('#party').addEventListener('change', applyFilter);
    el('#district').addEventListener('change', applyFilter);
    applyFilter();
  }
  main();

</script>
</body>
</html>
