<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>議會監督網站</title>
  <meta name="description" content="以 GitHub Pages 架設的議會監督網站：議員對照表、出席率、質詢率、連署與提案統計。" />
  <style>
    :root{
      --bg:#0b0f14; --panel:#121923; --muted:#9fb0c2; --text:#e6eef7; --brand:#4fa3ff; --ok:#3ccf91; --warn:#ffb020; --bad:#ff6b6b; --chip:#1c2633;
      --card:#0f1520; --hover:#172031; --border:#1f2a3a; --shadow:0 10px 30px rgba(2,12,27,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 10% -10%,#17304d10,transparent),
                     radial-gradient(900px 600px at 110% 10%,#1e3a5f10,transparent),var(--bg);
         color:var(--text);font:16px/1.6 system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", sans-serif}
    a{color:inherit}
    .container{max-width:1200px;margin:0 auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#4fa3ff,#7bd7ff);display:grid;place-items:center;color:#001428;font-weight:900;box-shadow:var(--shadow)}
    .title h1{margin:0;font-size:20px}
    .title p{margin:0;color:var(--muted);font-size:12px}

    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .input{background:var(--panel);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:10px;outline:none;box-shadow:none;}
    .input:focus{border-color:var(--brand)}
    .chip{background:var(--chip);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px;border:1px solid var(--border)}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px;margin-top:18px}
    .card{grid-column:span 6;background:linear-gradient(180deg,rgba(79,163,255,.06),transparent 40%),var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;position:relative;transition:.2s;box-shadow:0 0 0 rgba(0,0,0,0)}
    @media (min-width:900px){.card{grid-column:span 4}}
    .card:hover{transform:translateY(-2px);background:linear-gradient(180deg,rgba(79,163,255,.09),transparent 50%),var(--card);box-shadow:var(--shadow)}

    .card-head{display:flex;gap:12px}
    .avatar{width:64px;height:64px;border-radius:14px;flex:0 0 auto;object-fit:cover;border:1px solid var(--border);background:#0a0f16}
    .name{font-weight:700}
    .meta{color:var(--muted);font-size:13px}

    .metrics{display:grid;grid-template-columns:repeat(12,1fr);gap:10px;margin-top:10px}
    .metric{grid-column:span 6;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:8px}
    @media (min-width:900px){.metric{grid-column:span 3}}
    .metric h4{margin:0 0 6px 0;font-size:12px;color:var(--muted);font-weight:600}
    .metric .val{font-size:18px;font-weight:800}
    .bar{height:8px;background:#0e1420;border-radius:999px;border:1px solid var(--border);overflow:hidden;margin-top:6px}
    .bar>i{display:block;height:100%;background:linear-gradient(90deg,var(--ok),var(--brand));width:0}

    .card .more{position:absolute;right:10px;top:10px;background:transparent;border:1px solid var(--border);color:var(--muted);border-radius:8px;padding:6px 8px;cursor:pointer}
    .card .more:hover{background:var(--hover);color:var(--text)}

    .table-wrap{margin-top:28px;background:var(--panel);border:1px solid var(--border);border-radius:16px;overflow:auto}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
    th{position:sticky;top:0;background:linear-gradient(180deg,rgba(79,163,255,.06),transparent 30%),var(--panel);}

    /* Drawer */
    .drawer{position:fixed;inset:0;display:none}
    .drawer.show{display:block}
    .backdrop{position:absolute;inset:0;background:rgba(2,12,27,.55)}
    .panel{position:absolute;inset:0 0 0 auto;width:min(760px,100%);background:var(--panel);border-left:1px solid var(--border);box-shadow:var(--shadow);overflow:auto}
    .panel header{position:sticky;top:0;background:linear-gradient(180deg,rgba(79,163,255,.08),transparent 60%),var(--panel);border-bottom:1px solid var(--border);padding:14px}
    .panel .body{padding:16px}

    .kpis{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .kpi{grid-column:span 6;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
    @media (min-width:900px){.kpi{grid-column:span 3}}
    .kpi h3{margin:0;color:var(--muted);font-size:12px}
    .kpi .big{font-size:28px;font-weight:800;margin-top:4px}

    .list{margin-top:10px}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--border);font-size:11px;color:var(--muted)}

    footer{margin:40px 0 20px;color:var(--muted);font-size:12px;text-align:center}
    code.inline{background:#0e1420;border:1px solid var(--border);padding:2px 6px;border-radius:6px;color:#9bd}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">議</div>
        <div class="title">
          <h1>議會監督網站</h1>
          <p>議員對照表 · 出席率 · 質詢率 · 連署 · 提案數</p>
        </div>
      </div>
      <div class="toolbar">
        <input id="q" class="input" placeholder="搜尋議員姓名 / 系級 / 職稱..." />
        <span id="count" class="chip">0 位議員</span>
        <span id="live" class="chip" title="資料即時更新">離線資料</span>
      </div>
    </header>

    <section id="cards" class="grid" aria-live="polite"></section>

    <div class="table-wrap" id="tableWrap">
      <table id="table">
        <thead>
          <tr>
            <th>議員</th>
            <th>系級 / 單位</th>
            <th>職稱</th>
            <th>出席率</th>
            <th>質詢率</th>
            <th>連署數</th>
            <th>提案數</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <footer>
      在網址加上 <code class="inline">?sheet=&lt;議員統計CSV&gt;&amp;proposals=&lt;提案清單CSV&gt;</code>，兩個 CSV 可以都出自同一份 Google 試算表（不同工作表）。
    </footer>
  </div>

  <!-- 詳細抽屜 -->
  <div id="drawer" class="drawer" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="backdrop" onclick="closeDrawer()"></div>
    <div class="panel">
      <header>
        <div class="brand">
          <img id="dPhoto" class="avatar" alt="議員照片" />
          <div class="title">
            <h1 id="dName" style="margin:0;font-size:18px"></h1>
            <p id="dMeta" class="meta"></p>
          </div>
        </div>
        <button class="more" onclick="closeDrawer()">關閉</button>
      </header>
      <div class="body">
        <div class="kpis">
          <div class="kpi"><h3>出席率</h3><div id="dAttend" class="big">—</div></div>
          <div class="kpi"><h3>質詢率</h3><div id="dInterp" class="big">—</div></div>
          <div class="kpi"><h3>連署數</h3><div id="dCo" class="big">—</div></div>
          <div class="kpi"><h3>提案數</h3><div id="dProp" class="big">—</div></div>
        </div>
        <div class="list" id="dList"></div>
      </div>
    </div>
  </div>

<script>
  const POLL_MS = 60000;
  const state = { all: [], filtered: [], current: null, live:false, source:'', proposalsByName:new Map(), propSource:'' };

  async function main(){
    await initCouncilors();
    await initProposals();
    render();
    el('#q').addEventListener('input', applyFilter);
    if(state.live){ setInterval(async()=>{ const fresh = await loadCouncilorsCSV(state.source); if(fresh && changed(fresh,state.all)){ state.all = fresh; render(); } }, POLL_MS); }
    if(state.propSource){ setInterval(async()=>{ const t = await fetchText(state.propSource); const fresh = parseProposalsCsv(t); if(fresh && JSON.stringify([...fresh])!==JSON.stringify([...state.proposalsByName])){ state.proposalsByName = fresh; if(state.current) openDrawer(state.current.id); } }, POLL_MS); }
  }

  async function initCouncilors(){
    const sheetUrl = getParam('sheet');
    if(sheetUrl){
      const rows = await loadCouncilorsCSV(sheetUrl);
      if(rows){ state.live=true; state.source = sheetUrl; setLiveBadge(true); state.all = rows; return; }
    }
    const localCsv = await loadCouncilorsCSV('data/councilors.csv').catch(()=>null);
    if(localCsv){ setLiveBadge(false); state.all = localCsv; return; }
    try{ const res = await fetch('data/councilors.json',{cache:'no-store'}); if(res.ok){ setLiveBadge(false); state.all = await res.json(); return; } }catch(e){}
    setLiveBadge(false); state.all = SAMPLE_COUNCILORS;
  }

  async function initProposals(){
    const pUrl = getParam('proposals');
    if(pUrl){ const txt = await fetchText(pUrl); if(txt){ state.proposalsByName = parseProposalsCsv(txt); state.propSource=pUrl; return; } }
    try{ const res = await fetch('data/proposals.csv',{cache:'no-store'}); if(res.ok){ const txt = await res.text(); state.proposalsByName = parseProposalsCsv(txt); return; } }catch(e){}
    const m = new Map(); for(const x of state.all){ if(Array.isArray(x.proposals)) m.set(x.name, x.proposals); } state.proposalsByName = m;
  }

  function setLiveBadge(on){ const b = el('#live'); b.textContent = on? '即時資料（輪詢中）' : '離線資料'; }

  async function loadCouncilorsCSV(url){
    try{ const res = await fetch(url+((url.includes('?')?'&':'?')+'t='+Date.now())); if(!res.ok) return null; const text = await res.text(); return parseCouncilorsCsv(text); }catch(err){ return null; }
  }

  function parseCouncilorsCsv(csv){
    const lines = csv.split(/\r?\n/).filter(l=>l.trim().length);
    if(!lines.length) return [];
    const headers = splitCsvLine(lines[0]).map(h=>h.trim());
    const idx = (name)=> headers.findIndex(h=>h===name);
    const iName = idx('姓名');
    const iDept = idx('系級/單位');
    const iTitle = idx('職稱')>-1? idx('職稱'): idx('職務');
    const iPhoto = idx('照片URL');
    const iAttend = idx('出席率');
    const iInterp = idx('質詢率');
    const iCo = idx('連署數');
    const iProp = idx('提案數');
    const rows=[];
    for(let r=1;r<lines.length;r++){
      const cells = splitCsvLine(lines[r]);
      const name = cells[iName]?.trim();
      if(!name) continue;
      rows.push({
        id: 'id_'+String(r).padStart(3,'0'),
        name,
        party: '',
        department: cells[iDept]?.trim()||'',
        title: cells[iTitle]?.trim()||'',
        photo: normalizePhoto(cells[iPhoto]?.trim()||''),
        stats:{
          attendance_rate: numOrNull(cells[iAttend]),
          interpellation_rate: numOrNull(cells[iInterp]),
          cosponsors_count: intOr0(cells[iCo]),
          proposals_count: intOr0(cells[iProp])
        }
      })
    }
    return rows;
  }

  function parseProposalsCsv(csv){
    const lines = csv.split(/\r?\n/).filter(l=>l.trim().length);
    if(!lines.length) return new Map();
    const headers = splitCsvLine(lines[0]).map(h=>h.trim());
    const idx = (names)=>{ for(const n of names){ const i = headers.findIndex(h=>h===n); if(i>-1) return i; } return -1; };
    const iMember = idx(['議員','姓名']);
    const iTitle = idx(['標題','提案標題']);
    const iDate = idx(['日期','提出日期','登錄日期']);
    const iType = idx(['類型','類別','類別/狀態']);
    const iCo = idx(['連署','連署名單','連署議員']);
    const map = new Map();
    for(let r=1;r<lines.length;r++){
      const cells = splitCsvLine(lines[r]);
      const name = (cells[iMember]||'').trim(); if(!name) continue;
      const title = (cells[iTitle]||'').trim();
      const date = (cells[iDate]||'').trim();
      const type = (cells[iType]||'').trim();
      const cos = (cells[iCo]||'').split(/[、,;，；]/).map(s=>s.trim()).filter(Boolean);
      const item = {title: title||'(無標題)', date, type: type||'提案', cosponsors: cos};
      if(!map.has(name)) map.set(name, []);
      map.get(name).push(item);
    }
    for(const [k,arr] of map){ arr.sort((a,b)=> (b.date||'').localeCompare(a.date||'')); }
    return map;
  }

  function splitCsvLine(line){
    const out=[]; let cur=''; let q=false;
    for(let i=0;i<line.length;i++){
      const ch = line[i];
      if(ch==='"'){ if(q && line[i+1]==='"'){ cur+='"'; i++; } else { q=!q; } }
      else if(ch===',' && !q){ out.push(cur); cur=''; }
      else { cur+=ch; }
    }
    out.push(cur); return out;
  }

  function normalizePhoto(url){
    if(!url) return url;
    const m = url.match(/\/d\/([\w-]+)/);
    if(m){ return `https://drive.google.com/uc?export=view&id=${m[1]}`; }
    return url;
  }

  function numOrNull(x){ const v=parseFloat(x); return isFinite(v)? v: null; }
  function intOr0(x){ const v=parseInt(x,10); return isFinite(v)? v: 0; }
  function changed(a,b){ return JSON.stringify(a)!==JSON.stringify(b); }

  const el = sel=>document.querySelector(sel);
  const fmtPct = n => (n==null? '—' : Math.round(n*100)+'%');
  const fmtNum = n => n==null? '—' : Number(n).toLocaleString('zh-TW');
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

  function metricBar(val){
    const pct = Math.round((val||0)*100);
    return `<div class="bar"><i style="width:${clamp(pct,0,100)}%"></i></div>`
  }

  function render(){ applyFilter(); }
  function applyFilter(){
    const q = el('#q').value.trim();
    state.filtered = state.all.filter(x=>{
      const text = (x.name+" "+(x.department||'')+" "+(x.title||'')).toLowerCase();
      return !q || text.includes(q.toLowerCase());
    });
    el('#count').textContent = `${state.filtered.length} 位議員`;
    renderCards(); renderTable();
  }

  function renderCards(){
    const wrap = el('#cards');
    wrap.innerHTML = state.filtered.map(x=>{
      const m = x.stats || {};
      return `<article class="card" role="button" tabindex="0" onclick="openDrawer('${x.id}')" onkeypress="if(event.key==='Enter'){openDrawer('${x.id}')}" aria-label="查看 ${x.name} 詳細">
        <button class="more">詳情</button>
        <div class="card-head">
          <img class="avatar" alt="${x.name} 照片" src="${safePhoto(x.photo,x.name)}" onerror="this.src='https://picsum.photos/seed/${encodeURIComponent(x.name)}/128/128'"/>
          <div>
            <div class="name">${x.name}</div>
            <div class="meta">${(x.department||'').trim()} · ${(x.title||'').trim()}</div>
          </div>
        </div>
        <div class="metrics">
          <div class="metric"><h4>出席率</h4><div class="val">${fmtPct(m.attendance_rate)}</div>${metricBar(m.attendance_rate)}</div>
          <div class="metric"><h4>質詢率</h4><div class="val">${fmtPct(m.interpellation_rate)}</div>${metricBar(m.interpellation_rate)}</div>
          <div class="metric"><h4>連署數</h4><div class="val">${fmtNum(m.cosponsors_count)}</div></div>
          <div class="metric"><h4>提案數</h4><div class="val">${fmtNum(m.proposals_count)}</div></div>
        </div>
      </article>`
    }).join('');
  }

  function renderTable(){
    const tb = document.querySelector('#table tbody');
    tb.innerHTML = state.filtered.map(x=>{
      const m = x.stats||{};
      return `<tr onclick="openDrawer('${x.id}')" style="cursor:pointer">
        <td>${x.name}</td>
        <td>${x.department||''}</td>
        <td>${x.title||''}</td>
        <td>${fmtPct(m.attendance_rate)}</td>
        <td>${fmtPct(m.interpellation_rate)}</td>
        <td>${fmtNum(m.cosponsors_count)}</td>
        <td>${fmtNum(m.proposals_count)}</td>
      </tr>`
    }).join('');
  }

  function safePhoto(url,name){
    const u = normalizePhoto(url||'');
    return u && u.trim() ? u : `https://picsum.photos/seed/${encodeURIComponent(name)}/128/128`;
  }

  function openDrawer(id){
    const x = state.all.find(v=>v.id===id);
    if(!x) return;
    state.current = x;
    el('#dPhoto').src = safePhoto(x.photo,x.name);
    el('#dName').textContent = x.name;
    el('#dMeta').textContent = `${(x.department||'').trim()} · ${(x.title||'').trim()}`;
    el('#dAttend').textContent = fmtPct(x.stats?.attendance_rate);
    el('#dInterp').textContent = fmtPct(x.stats?.interpellation_rate);
    el('#dCo').textContent = fmtNum(x.stats?.cosponsors_count);
    el('#dProp').textContent = fmtNum(x.stats?.proposals_count);

    const list = state.proposalsByName.get(x.name) || x.proposals || [];
    el('#dList').innerHTML = (list.length? list.slice(0,30).map(it=>
      `<div style="display:flex;gap:10px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;margin:6px 0">
        <span class="pill">${it.type||'提案'}</span>
        <div style="flex:1">
          <div style="font-weight:700">${it.title||'(無標題)'}</div>
          <div class="meta">${it.date||''}${(it.cosponsors&&it.cosponsors.length)? ' · 連署：'+it.cosponsors.join('、'):''}</div>
        </div>
      </div>`
    ).join('') : `<div class="meta">暫無提案資料。請提供 ?proposals=CSV 或 data/proposals.csv。</div>`);
    const dr = el('#drawer'); dr.classList.add('show'); dr.setAttribute('aria-hidden','false');
  }
  function closeDrawer(){ const dr = el('#drawer'); dr.classList.remove('show'); dr.setAttribute('aria-hidden','true'); }

  const SAMPLE_COUNCILORS = [
    { id:'c001', name:'林雅雯', party:'', department:'社會系大二', title:'學生議員', photo:'', stats:{attendance_rate:.96, interpellation_rate:.52, cosponsors_count:48, proposals_count:22},
      proposals:[{title:'推動學校營養午餐在地採購計畫', date:'2025-07-12', type:'提案'}]},
    { id:'c002', name:'王博仁', party:'', department:'哲學系碩一', title:'學生議員', photo:'', stats:{attendance_rate:.82, interpellation_rate:.31, cosponsors_count:35, proposals_count:12}}
  ];

  function getParam(key){ const u = new URL(window.location.href); return u.searchParams.get(key); }
  async function fetchText(url){ try{ const res = await fetch(url+((url.includes('?')?'&':'?')+'t='+Date.now())); if(res.ok) return await res.text(); }catch(e){} return ''; }

  main();
</script>
</body>
</html>
