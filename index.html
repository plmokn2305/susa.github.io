<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>議會監督網站</title>
  <meta name="description" content="以 GitHub Pages 架設的議會監督網站：議員對照表、出席率、質詢率、連署與提案統計。" />
  <style>
    :root{ --bg:#0b0f14; --panel:#121923; --muted:#9fb0c2; --text:#e6eef7; --brand:#4fa3ff; --ok:#3ccf91; --warn:#ffb020; --bad:#ff6b6b; --chip:#1c2633; --card:#0f1520; --hover:#172031; --border:#1f2a3a; --shadow:0 10px 30px rgba(2,12,27,.35); }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 10% -10%,#17304d10,transparent), radial-gradient(900px 600px at 110% 10%,#1e3a5f10,transparent), var(--bg); color:var(--text);font:16px/1.6 system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", sans-serif}
    a{color:inherit}
    .container{max-width:1200px;margin:0 auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#4fa3ff,#7bd7ff);display:grid;place-items:center;color:#001428;font-weight:900;box-shadow:var(--shadow)}
    .title h1{margin:0;font-size:20px}.title p{margin:0;color:var(--muted);font-size:12px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .input{background:var(--panel);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:10px}
    .input:focus{border-color:var(--brand)}.chip{background:var(--chip);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px;border:1px solid var(--border)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px;margin-top:18px}
    .card{grid-column:span 6;background:linear-gradient(180deg,rgba(79,163,255,.06),transparent 40%),var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;position:relative;transition:.2s}
    @media (min-width:900px){.card{grid-column:span 4}} .card:hover{transform:translateY(-2px);background:linear-gradient(180deg,rgba(79,163,255,.09),transparent 50%),var(--card);box-shadow:var(--shadow)}
    .card-head{display:flex;gap:12px}.avatar{width:64px;height:64px;border-radius:14px;object-fit:cover;border:1px solid var(--border);background:#0a0f16}
    .name{font-weight:700}.meta{color:var(--muted);font-size:13px}
    .metrics{display:grid;grid-template-columns:repeat(12,1fr);gap:10px;margin-top:10px}
    .metric{grid-column:span 6;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:8px}
    @media (min-width:900px){.metric{grid-column:span 3}} .metric h4{margin:0 0 6px 0;font-size:12px;color:var(--muted);font-weight:600}.metric .val{font-size:18px;font-weight:800}
    .bar{height:8px;background:#0e1420;border-radius:999px;border:1px solid var(--border);overflow:hidden;margin-top:6px}.bar>i{display:block;height:100%;background:linear-gradient(90deg,var(--ok),var(--brand));width:0}
    .table-wrap{margin-top:28px;background:var(--panel);border:1px solid var(--border);border-radius:16px;overflow:auto}
    table{width:100%;border-collapse:collapse}th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
    th{position:sticky;top:0;background:linear-gradient(180deg,rgba(79,163,255,.06),transparent 30%),var(--panel)}
    .drawer{position:fixed;inset:0;display:none}.drawer.show{display:block}.backdrop{position:absolute;inset:0;background:rgba(2,12,27,.55)}
    .panel{position:absolute;inset:0 0 0 auto;width:min(760px,100%);background:var(--panel);border-left:1px solid var(--border);box-shadow:var(--shadow);overflow:auto}
    .panel header{position:sticky;top:0;background:linear-gradient(180deg,rgba(79,163,255,.08),transparent 60%),var(--panel);border-bottom:1px solid var(--border);padding:14px}
    .panel .body{padding:16px}.kpis{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .kpi{grid-column:span 6;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
    @media (min-width:900px){.kpi{grid-column:span 3}} .kpi h3{margin:0;color:var(--muted);font-size:12px}.kpi .big{font-size:28px;font-weight:800;margin-top:4px}
    .list{margin-top:10px}.pill{display:inline-block;padding:3px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--border);font-size:11px;color:var(--muted)}
    footer{margin:40px 0 20px;color:var(--muted);font-size:12px;text-align:center}code.inline{background:#0e1420;border:1px solid var(--border);padding:2px 6px;border-radius:6px;color:#9bd}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand"><div class="logo">議</div><div class="title"><h1>議會監督網站</h1><p>議員對照表 · 出席率 · 質詢率 · 連署 · 提案數</p></div></div>
      <div class="toolbar"><input id="q" class="input" placeholder="搜尋議員姓名 / 系級 / 職稱..." /><span id="count" class="chip">0 位議員</span><span id="live" class="chip" title="資料即時更新">離線資料</span></div>
    </header>

    <section id="cards" class="grid" aria-live="polite"></section>

    <div class="table-wrap" id="tableWrap">
      <table id="table"><thead><tr><th>議員</th><th>系級 / 單位</th><th>職稱</th><th>出席率</th><th>質詢率</th><th>連署數</th><th>提案數</th></tr></thead><tbody></tbody></table>
    </div>

    <footer>推薦：只用 <code class="inline">?api=&lt;你的 Google Apps Script Web App URL&gt;</code> 一個端點，即時回傳合併 JSON（統計＋提案）。也相容舊參數 <code class="inline">?sheet=</code> 與 <code class="inline">?proposals=</code>。</footer>
  </div>

  <div id="drawer" class="drawer" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="backdrop" onclick="closeDrawer()"></div>
    <div class="panel">
      <header><div class="brand"><img id="dPhoto" class="avatar" alt="議員照片" /><div class="title"><h1 id="dName" style="margin:0;font-size:18px"></h1><p id="dMeta" class="meta"></p></div></div><button class="more" onclick="closeDrawer()">關閉</button></header>
      <div class="body">
        <div class="kpis">
          <div class="kpi"><h3>出席率</h3><div id="dAttend" class="big">—</div></div>
          <div class="kpi"><h3>質詢率</h3><div id="dInterp" class="big">—</div></div>
          <div class="kpi"><h3>連署數</h3><div id="dCo" class="big">—</div></div>
          <div class="kpi"><h3>提案數</h3><div id="dProp" class="big">—</div></div>
        </div>
        <div class="list" id="dList"></div>
      </div>
    </div>
  </div>

<script>
  const POLL_MS = 60000;
  const state = { all: [], filtered: [], current: null, live:false, source:'', proposalsByName:new Map(), propSource:'', api:'' };

  async function main(){
    const api = getParam('api');
    if(api){ state.api = api; await loadFromAPI(api); setLiveBadge(true); setInterval(()=>loadFromAPI(api,true), POLL_MS); }
    else { await initCouncilorsAndProposalsFallback(); }
    render();
    el('#q').addEventListener('input', applyFilter);
  }

  async function loadFromAPI(url, isPoll=false){
    try{
      const res = await fetch(url + (url.includes('?')?'&':'?') + 't=' + Date.now());
      if(!res.ok) throw new Error('bad status');
      const data = await res.json();
      const parsed = parseApiPayload(data);
      if(!isPoll || JSON.stringify(parsed.all)!==JSON.stringify(state.all) || JSON.stringify([...parsed.proposals])!==JSON.stringify([...state.proposalsByName])){
        state.all = parsed.all;
        state.proposalsByName = parsed.proposals;
        render();
        if(state.current) openDrawer(state.current.id);
      }
    }catch(e){
      if(!isPoll){ console.error('API 載入失敗，改用備援'); await initCouncilorsAndProposalsFallback(); }
    }
  }

  function parseApiPayload(data){
    const all = (data.councilors||[]).map((x,i)=>({
      id: x.id || ('id_'+String(i).padStart(3,'0')),
      name: x.name, department: x.department||'', title: x.title||'', photo: normalizePhoto(x.photo||''),
      stats: {
        attendance_rate: numOrNull(x.stats && x.stats.attendance_rate),
        interpellation_rate: numOrNull(x.stats && x.stats.interpellation_rate),
        cosponsors_count: intOr0(x.stats && x.stats.cosponsors_count),
        proposals_count: intOr0(x.stats && x.stats.proposals_count),
      }
    }));
    const m = new Map();
    for(const x of (data.councilors||[])){
      if(Array.isArray(x.proposals)) m.set(x.name, x.proposals.map(p=>({title:p.title||'(無標題)', date:p.date||'', type:p.type||'提案', cosponsors: Array.isArray(p.cosponsors)? p.cosponsors: []})));
    }
    return { all, proposals: m };
  }

  async function initCouncilorsAndProposalsFallback(){
    await initCouncilors();
    await initProposals();
  }

  async function initCouncilors(){
    const sheetUrl = getParam('sheet');
    if(sheetUrl){
      const rows = await loadCouncilorsCSV(sheetUrl);
      if(rows){ state.live=true; state.source = sheetUrl; setLiveBadge(true); state.all = rows; return; }
    }
    const localCsv = await loadCouncilorsCSV('data/councilors.csv').catch(()=>null);
    if(localCsv){ setLiveBadge(false); state.all = localCsv; return; }
    try{ const res = await fetch('data/councilors.json',{cache:'no-store'}); if(res.ok){ setLiveBadge(false); state.all = await res.json(); return; } }catch(e){}
    setLiveBadge(false); state.all = SAMPLE_COUNCILORS;
  }

  async function initProposals(){
    const pUrl = getParam('proposals');
    if(pUrl){ const txt = await fetchText(pUrl); if(txt){ state.proposalsByName = parseProposalsCsv(txt); state.propSource=pUrl; return; } }
    try{ const res = await fetch('data/proposals.csv',{cache:'no-store'}); if(res.ok){ const txt = await res.text(); state.proposalsByName = parseProposalsCsv(txt); return; } }catch(e){}
    const m = new Map(); for(const x of state.all){ if(Array.isArray(x.proposals)) m.set(x.name, x.proposals); } state.proposalsByName = m;
  }

  function setLiveBadge(on){ const b = el('#live'); b.textContent = on? '即時資料（輪詢中）' : '離線資料'; }
  async function loadCouncilorsCSV(url){ try{ const res = await fetch(url+((url.includes('?')?'&':'?')+'t='+Date.now())); if(!res.ok) return null; const text = await res.text(); return parseCouncilorsCsv(text); }catch(err){ return null; } }
  function parseCouncilorsCsv(csv){
    const lines = csv.split(/\r?\n/).filter(l=>l.trim().length);
    if(!lines.length) return [];
    const headers = splitCsvLine(lines[0]).map(h=>h.trim());
    const idx = (name)=> headers.findIndex(h=>h===name);
    const iName = idx('姓名'), iDept = idx('系級/單位'), iTitle = (headers.includes('職稱')? idx('職稱'): idx('職務')), iPhoto = idx('照片URL');
    const iAttend = idx('出席率'), iInterp = idx('質詢率'), iCo = idx('連署數'), iProp = idx('提案數');
    const rows=[];
    for(let r=1;r<lines.length;r++){
      const cells = splitCsvLine(lines[r]); const name = cells[iName]?.trim(); if(!name) continue;
      rows.push({ id:'id_'+String(r).padStart(3,'0'), name, department: cells[iDept]?.trim()||'', title: cells[iTitle]?.trim()||'', photo: normalizePhoto(cells[iPhoto]?.trim()||''),
        stats:{ attendance_rate: numOrNull(cells[iAttend]), interpellation_rate: numOrNull(cells[iInterp]), cosponsors_count: intOr0(cells[iCo]), proposals_count: intOr0(cells[iProp]) } });
    }
    return rows;
  }

  function parseProposalsCsv(csv){
    const lines = csv.split(/\r?\n/).filter(l=>l.trim().length); if(!lines.length) return new Map();
    const headers = splitCsvLine(lines[0]).map(h=>h.trim());
    const idx = (names)=>{ for(const n of names){ const i = headers.findIndex(h=>h===n); if(i>-1) return i; } return -1; };
    const iMember = idx(['議員','姓名']), iTitle = idx(['標題','提案標題']), iDate = idx(['日期','提出日期','登錄日期']), iType = idx(['類型','類別','類別/狀態']), iCo = idx(['連署','連署名單','連署議員']);
    const map = new Map();
    for(let r=1;r<lines.length;r++){
      const cells = splitCsvLine(lines[r]);
      const name = (cells[iMember]||'').trim(); if(!name) continue;
      const title = (cells[iTitle]||'').trim(); const date = (cells[iDate]||'').trim(); const type = (cells[iType]||'').trim();
      const cos = (cells[iCo]||'').split(/[、,;，；]/).map(s=>s.trim()).filter(Boolean);
      const item = {title: title||'(無標題)', date, type: type||'提案', cosponsors: cos};
      if(!map.has(name)) map.set(name, []); map.get(name).push(item);
    }
    for(const [k,arr] of map){ arr.sort((a,b)=> (b.date||'').localeCompare(a.date||'')); } return map;
  }

  function splitCsvLine(line){ const out=[]; let cur='', q=false; for(let i=0;i<line.length;i++){ const ch=line[i]; if(ch==='"'){ if(q && line[i+1]==='"'){ cur+='"'; i++; } else { q=!q; } } else if(ch===',' && !q){ out.push(cur); cur=''; } else { cur+=ch; } } out.push(cur); return out; }
  function normalizePhoto(url){ if(!url) return url; const m = url.match(/\/d\/([\w-]+)/); if(m){ return `https://drive.google.com/uc?export=view&id=${m[1]}`; } return url; }
  function numOrNull(x){ const v=parseFloat(x); return isFinite(v)? v: null; } function intOr0(x){ const v=parseInt(x||'0',10); return isFinite(v)? v: 0; }
</script>
</body>
</html>
